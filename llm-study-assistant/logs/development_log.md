# 开发日志 - 2025-09-18

## 目标
解决应用稳定性、OBS录屏控制及前端UI交互的核心问题，为后续的屏幕实时问答功能铺平道路。

## 关键问题与解决方案

### 1. 服务启动健壮性
- **问题**: 主应用 (`run.py`) 在Ollama服务完全就绪前启动，导致LLM连接失败并显示“离线”。
- **分析**: 应用启动时只进行了一次性的连接检查，没有给Ollama服务留出足够的初始化时间。
- **解决**:
    - 重构 `app/main.py` 中的 `startup_event` 函数。
    - 引入了一个带超时（30秒）和延迟的**循环重试机制**，确保主应用会“耐心等待”Ollama服务准备就绪，显著提高了启动的成功率和稳定性。

### 2. 系统崩溃：资源耗尽
- **问题**: 在前端点击“提问”按钮后，后端服务崩溃，并导致整个操作系统重启。
- **分析**: 这是典型的“资源风暴”。RAG流程中的**文本向量化** (`sentence-transformers`) 和**LLM推理** (`Ollama`) 两个计算密集型任务，在瞬间无限制地抢占所有CPU核心和内存，导致内核恐慌（Kernel Panic）。
- **解决**:
    - **精确控制资源**: 修改应用的入口文件 `run.py`，在所有库导入前，通过设置环境变量 `os.environ['OMP_NUM_THREADS'] = '1'`，强制向量化计算过程只使用**单个CPU核心**。
    - **权衡与决策**: 放弃了在当前环境下因生态不成熟而极其复杂的AMD GPU（ROCm）方案，选择了CPU限制这个**零风险、高回报**的解决方案，以极小的性能代价换取了系统的绝对稳定。

### 3. 启动脚本错误 (`run.py`)
- **问题**: 在修复CPU问题的过程中，`run.py` 引入了 `NameError`，导致应用无法启动。
- **分析**: 忘记导入 `load_dotenv` 模块，且变量定义顺序混乱。
- **解决**: 彻底重构 `run.py`，将所有导入语句置于文件顶部，并整理了路径设置和环境变量加载的逻辑，使其清晰、健壮且符合Python最佳实践。

### 4. OBS录屏功能
- **问题 1**: 点击“开始录屏”失败，后台日志显示 `OBSSDKRequestError: Request StartRecord returned code 500`。
- **分析 1**: OBS WebSocket返回的 `500` 错误，通常是因为OBS软件本身没有配置默认的录屏文件保存路径。
- **解决 1**: 指导用户在OBS的“设置” -> “输出” -> “录像”中，指定一个有效的“录像路径”。

- **问题 2**: 后台日志显示 `pydantic` 数据验证错误，期望 `output_duration` 是字符串，但收到了整数。
- **分析 2**: `app/schemas.py` 中的 `RecordingStatus` 模型定义错误。
- **解决 2**: 修改 `RecordingStatus` 模型，将 `output_duration` 的类型从 `Optional[str]` 修正为 `Optional[float]`。

### 5. 前端UI交互
- **问题**: 开始录屏后，“停止”、“暂停”等按钮依然处于不可点击状态。
- **分析**: 前端JavaScript代码在发送录屏指令后，没有处理后端返回的状态信息来更新UI。
- **定位**: 问题出在 `frontend/index.html` 的 `recordingAction` 函数中。
- **下一步**: 已规划在 `TODO.md` 中，将作为最高优先级任务进行修复。

## 最终成果
- 应用已能稳定启动并与所有后端服务（LLM, OBS）可靠连接。
- 彻底解决了导致系统崩溃的资源耗尽问题。
- OBS录屏功能已能成功启动，核心障碍已清除。
- 明确了前端UI的bug，并为下一步的开发工作制定了清晰的路线图。

# 开发日志 - 2025-10-11

## 目标
修复前端访问和视频分析API的路由冲突问题，并根据用户反馈规划下一步的优化方向。

## 关键问题与解决方案

### 1. 前端静态资源加载失败 (404 Not Found)
- **问题**: 启动服务后，访问 `http://localhost:8000/`，浏览器可以加载 `index.html`，但页面发出的 `GET /system/status` 和 `GET /obs/recording/status` 等API请求全部返回404错误。
- **分析**: `app/main.py` 中存在两个功能重复的“全匹配”路由 (`@app.get("/{full_path:path}")`)。第一个路由错误地拦截了所有API请求，并尝试将它们作为前端页面请求处理，导致API无法被正确路由。
- **解决**: 删除了位于文件中间的多余的 `serve_frontend` 函数，只保留文件末尾的 `serve_frontend_catch_all` 作为处理前端路由的唯一入口，确保其在所有API路由之后匹配。

### 2. 视频分析功能失败 (405 Method Not Allowed)
- **问题**: 在前端点击“分析问答”按钮后，向 `/recordings/{filename}/analyze` 发送的 `POST` 请求失败，返回405错误。
- **分析**: `app/main.py` 中的 `app.mount("/recordings", ...)` 将所有以 `/recordings` 开头的URL都交给了静态文件服务器处理。静态文件服务只支持 `GET` 方法，因此 `POST` 请求被拒绝。
- **解决**: 删除了 `app.mount("/recordings", ...)` 这一行。文件下载功能已由 `@app.get("/recordings/{filename}")` 路由提供，该 `mount` 操作不仅多余，还引起了路由冲突。

### 3. 规划后续优化方向
- **问题**: 视频分析功能虽然可以调用，但结果不准确，无法正确识别题目和答案，前端展示格式也有待优化。
- **解决**:
    - 与用户沟通，明确了三点核心优化需求：增强OCR文本处理、修复问答逻辑、统一前端展示格式。
    - 创建了 `logs/TODO.md` 文件，将上述需求作为待办事项进行记录，为后续的迭代开发提供了清晰的路线图。

## 最终成果
- 成功解决了前端API调用404和视频分析功能405的两个核心路由问题，应用功能基本跑通。

